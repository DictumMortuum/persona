<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta charset="utf-8">
  <title>Persona</title>
  <meta name="description" content="Role playing games social network">
  <meta name="author" content="Dimitris Raviolos">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="dist/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="dist/css/bootstrap-material-design.css">
  <link rel="stylesheet" type="text/css" href="dist/css/ripples.min.css">
  <link rel="stylesheet" type="text/css" href="index.css">
  <!--[if lt IE 9]>
  <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
  <link rel="shortcut icon" href="favicon.ico">
</head>
<body>
  <div class="container main"></div>
  <script src="http://localhost/js/browser.min.js"></script>
  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="node_modules/mustache/mustache.min.js"></script>
  <script src="node_modules/pouchdb/dist/pouchdb.min.js"></script>
  <script src="node_modules/moment/moment.js"></script>
  <script src="lib/super.js"></script>
  <script src="lib/view.js"></script>
  <script src="lib/template.js"></script>
  <script src="lib/transform.js"></script>
  <script src="lib/database.js"></script>
  <script>
  var db = new Database({
    pouch: window.PouchDB,
    local: "persona",
    remote: "http://localhost:5984/persona",
    change: (info) => {
      var doc = info.change.docs[0]
      console.log(doc)

      if(transform.deleted(doc)) {
        db.remove(doc._id, doc._rev)
        $("#" + doc._id).hide()
      } else {
        if($("#user-" + doc.from).length === 0) {
          $(template.render("user", {username: doc.from})).appendTo("#inbox-menu")
        }

        if($("#inbox-user-" + doc.from).length === 0) {
          $(template.render("page", {username: doc.from})).appendTo("#inbox-list")
        }

        $(template.render("message", doc)).appendTo("#inbox-user-" + doc.from)
      }
    }
  })

  var transform = new Transform({
    moment: window.moment
  })

  var template = new Template({
    path: "tpl/",
    engine: window.Mustache,
    promise: window.Promise
  })

  var view = new View({
    template: template,
    transform: transform,
    db: db,
    jQuery: $
  })

  Promise.all([
    db.init(),
    template.init(["message", "list", "user", "navbar", "page", "home"])
  ]).then(function() {
    view.render()
  })

  </script>
  <script src="dist/js/bootstrap.min.js"></script>
  <script src="dist/js/material.js"></script>
  <script src="dist/js/ripples.js"></script>
  <script>
    $.material.init()
  </script>
</body>
</html>
