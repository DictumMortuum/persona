<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta charset="utf-8">
  <title>Persona</title>
  <meta name="description" content="Role playing games social network">
  <meta name="author" content="Dimitris Raviolos">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="dist/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="dist/css/bootstrap-material-design.css">
  <link rel="stylesheet" type="text/css" href="dist/css/ripples.min.css">
  <link rel="stylesheet" type="text/css" href="index.css">
  <!--[if lt IE 9]>
  <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
  <link rel="shortcut icon" href="favicon.ico">
</head>
<body>
  <div class="container main" id="container"></div>
  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="node_modules/mustache/mustache.min.js"></script>
  <script src="node_modules/pouchdb/dist/pouchdb.min.js"></script>
  <script src="node_modules/moment/moment.js"></script>
  <script src="dist/js/react.min.js"></script>
  <script src="dist/js/react-dom.min.js"></script>
  <script src="http://localhost/js/browser.min.js"></script>
  <script src="lib/doc.js"></script>
  <script src="lib/module.js"></script>
  <script src="lib/view.js"></script>
  <script src="lib/template.js"></script>
  <script src="lib/database.js"></script>
  <script type="text/babel">
  window.user = "someone"
  class PersonaMessage extends React.Component {
    render() {
      var raw

      if(this.props.doc.from === this.props.user) {
        raw = (
          <tr className="info">
            <td>{this.props.doc.text}</td>
            <td></td>
          </tr>
        )
      } else {
        raw = (
          <tr>
            <td></td>
            <td>{this.props.doc.text}</td>
          </tr>
        )
      }

      return raw
    }
  }

  class PersonaMessageList extends React.Component {
    constructor() {
      super()
      this.state = {
        name: undefined,
        data: [],
        user: undefined
      }
    }
    componentDidMount() {
      this.setState({
        name: this.props.name,
        data: this.props.data,
        user: window.user
      })
    }
    render() {
      var nodes = this.state.data.map((doc) => {
        return (
          <PersonaMessage doc={doc} user={this.state.user}/>
        )
      })
      return (
        <div className="col-md-3 col-xs-6">
          <div className="panel panel-primary">
            <div className="panel-heading">
              <h3 className="panel-title">{this.props.name}</h3>
            </div>
            <div className="panel-body">
              <table className="table table-hover">
                <tbody>
                {nodes}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      )
    }
  }

  class PersonaInbox extends React.Component {
    render() {
      var nodes = this.props.data.users.map((user) => {
        return (
          <PersonaMessageList name={user.name} data={user.docs} />
        )
      })
      return (
        <div className="row">
          <div className="col-xs-12">
            <div className="bs-component">
              {nodes}
            </div>
          </div>
        </div>
      )
    }
  }

  var db = new Database({
    pouch: window.PouchDB,
    local: "persona",
    remote: "http://localhost:5984/persona",
    change: (info) => {
      var doc = info.change.docs[0]
      console.log(doc)

      if(transform.deleted(doc)) {
        db.remove(doc._id, doc._rev)
        $("#" + doc._id).hide()
      } else {
        if($("#user-" + doc.from).length === 0) {
          $(template.render("user", {username: doc.from})).appendTo("#inbox-menu")
        }

        if($("#inbox-user-" + doc.from).length === 0) {
          $(template.render("page", {username: doc.from})).appendTo("#inbox-list")
        }

        $(template.render("message", doc)).appendTo("#inbox-user-" + doc.from)
      }
    }
  })

  var template = new Template({
    path: "tpl/",
    engine: window.Mustache,
    promise: window.Promise
  })

  var view = new View({
    template: template,
    db: db,
    jQuery: $
  })

  Promise.all([
    db.init(),
    template.init(["message", "list", "user", "navbar", "page", "home"])
  ]).then(function() {
    //view.render()
    db.query(
      d => d.type === "message"
    ).then(function(docs) {
      var inb = new Inbox(docs)
      setInterval(() => {
        inb.users[0].name = new Date().toString()
        /*inb.users[0].docs.push({
          id: new Date().toString(),
          rev: 0,
          text: new Date().toString(),
          date: ""
        })*/
        ReactDOM.render(
          <PersonaInbox data={inb} />,
          document.getElementById('container')
        )
      }, 50);
    })
  })
  </script>
  <script src="dist/js/bootstrap.min.js"></script>
  <script src="dist/js/material.js"></script>
  <script src="dist/js/ripples.js"></script>
  <script>
    $.material.init()
  </script>
</body>
</html>
